<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>nagios 安装与使用 - William</title><meta name="author" content="william">
<meta name="author-link" content="">
<meta name="description" content="nagios 是一款用于监控远程机器状态的开源软件，使用了服务端-客户端的设计架构。
本文将详细介绍服务端与客户端的安装步骤。" /><meta name="keywords" content='Linux, CentOS, nagios, openssl, log, monitor' /><meta itemprop="name" content="nagios 安装与使用">
<meta itemprop="description" content="nagios 是一款用于监控远程机器状态的开源软件，使用了服务端-客户端的设计架构。
本文将详细介绍服务端与客户端的安装步骤。"><meta itemprop="datePublished" content="2023-07-09T16:58:33+00:00" />
<meta itemprop="dateModified" content="2023-07-09T16:58:33+00:00" />
<meta itemprop="wordCount" content="5765"><meta itemprop="image" content="https://williamlfang.github.io/logo.png" />
<meta itemprop="keywords" content="Linux,CentOS,nagios,openssl,log,monitor," /><meta property="og:title" content="nagios 安装与使用" />
<meta property="og:description" content="nagios 是一款用于监控远程机器状态的开源软件，使用了服务端-客户端的设计架构。
本文将详细介绍服务端与客户端的安装步骤。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://williamlfang.github.io/2023-07-09-nagios-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" /><meta property="og:image" content="https://williamlfang.github.io/logo.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-09T16:58:33+00:00" />
<meta property="article:modified_time" content="2023-07-09T16:58:33+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://williamlfang.github.io/logo.png" /><meta name="twitter:title" content="nagios 安装与使用"/>
<meta name="twitter:description" content="nagios 是一款用于监控远程机器状态的开源软件，使用了服务端-客户端的设计架构。
本文将详细介绍服务端与客户端的安装步骤。"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://williamlfang.github.io/2023-07-09-nagios-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" /><link rel="prev" href="https://williamlfang.github.io/2023-07-08-nagios-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" /><link rel="next" href="https://williamlfang.github.io/2023-07-14-vim-latex/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "nagios 安装与使用",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/williamlfang.github.io\/2023-07-09-nagios-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8\/"
    },"genre": "posts","keywords": "Linux, CentOS, nagios, openssl, log, monitor","wordcount":  5765 ,
    "url": "https:\/\/williamlfang.github.io\/2023-07-09-nagios-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8\/","datePublished": "2023-07-09T16:58:33+00:00","dateModified": "2023-07-09T16:58:33+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "william"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="William"><img loading="lazy" src="/images/wuya-logo.png" alt="William" data-title="William" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">William</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-regular fa-newspaper fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/archives/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 归档</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/friends/"
                title="友情链接"
                
              ><i class="fa-solid fa-users-viewfinder fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about/"
                
                
              ><i class="fa-solid fa-signature fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/calendar/"
                
                
              ><i class="fa-regular fa-calendar fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 月历</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="William"><img loading="lazy" src="/images/wuya-logo.png" alt="/images/wuya-logo.png" data-title="/images/wuya-logo.png" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">William</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-regular fa-newspaper fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/archives/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 归档</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/friends/"
                  title="友情链接"
                  
                ><i class="fa-solid fa-users-viewfinder fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 友链</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about/"
                  
                  
                ><i class="fa-solid fa-signature fa-fw fa-sm" aria-hidden="true"></i> 关于</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/calendar/"
                  
                  
                ><i class="fa-regular fa-calendar fa-fw fa-sm fa-fw fa-sm" aria-hidden="true"></i> 月历</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>nagios 安装与使用</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="/images/william.jpg" alt="william" data-title="william" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;william</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/tools/" class="post-category" title="分类 - Tools"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Tools</a></span></div><div class="post-meta-line"><span title="发布于 2023-07-09 16:58:33"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2023-07-09">2023-07-09</time></span>&nbsp;<span title="5765 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 5800 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 12 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ol>
    <li><a href="#服务端">服务端</a>
      <ol>
        <li><a href="#安装-nagios-core">安装 nagios-core</a></li>
        <li><a href="#安装-nagios-plugin">安装 nagios-plugin</a></li>
        <li><a href="#安装-nagios-nrpe">安装 nagios-nrpe</a></li>
        <li><a href="#启动服务">启动服务</a></li>
        <li><a href="#添加监控客户机器">添加监控客户机器</a></li>
      </ol>
    </li>
    <li><a href="#客户端">客户端</a>
      <ol>
        <li><a href="#安装-nagios-plugin-1">安装 nagios-plugin</a></li>
        <li><a href="#安装-nagios-nrpe-1">安装 nagios-nrpe</a></li>
        <li><a href="#启动服务-1">启动服务</a></li>
      </ol>
    </li>
    <li><a href="#编写-nagios-plugin">编写 nagios-plugin</a>
      <ol>
        <li><a href="#show-users">show-users</a>
          <ol>
            <li><a href="#代码">代码</a></li>
            <li><a href="#配置">配置</a></li>
          </ol>
        </li>
        <li><a href="#配置-nagios-graph">配置 nagios-graph</a></li>
        <li><a href="#配置-pnp4nagios">配置 pnp4nagios</a>
          <ol>
            <li><a href="#安装-pnp4nagios">安装 pnp4nagios</a>
              <ol>
                <li><a href="#配置-1">配置</a></li>
              </ol>
            </li>
            <li><a href="#grafana">grafana</a></li>
            <li><a href="#企业微信通知">企业微信通知</a>
              <ol>
                <li><a href="#建立-python-通知脚本">建立 python 通知脚本</a></li>
                <li><a href="#修改-generic-contact">修改 generic-contact</a></li>
                <li><a href="#修改-contact">修改 contact</a></li>
                <li><a href="#添加监控-commands">添加监控 commands</a></li>
                <li><a href="#设置监控项目">设置监控项目</a></li>
              </ol>
            </li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#ref">Ref</a></li>
  </ol>
</nav></div>
      </div><div class="content" id="content"><div class="details admonition warning open">
      <div class="details-summary admonition-title">
        <i class="icon fa-solid fa-exclamation-triangle fa-fw" aria-hidden="true"></i>警告<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
      </div>
      <div class="details-content">
        <div class="admonition-content">本文最后更新于 2023-07-09，文中内容可能已过时。</div>
      </div>
    </div><p><code>nagios</code> 是一款用于监控远程机器状态的开源软件，使用了服务端-客户端的设计架构。</p>
<p>本文将详细介绍服务端与客户端的安装步骤。</p>
<p>其中，特别需要注意的是：</p>
<ul>
<li>
<p>目前 <code>NRPE</code> 只能支持 <code>openssl-1.1.1</code> 版本的 <code>ssl</code> 功能，否则会出现错误</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ccxhAMXP.o: In <span class="k">function</span> <span class="sb">`</span>get_dh2048<span class="s1">&#39;:
</span></span></span><span class="line"><span class="cl"><span class="s1">/tmp/nrpe-4.1.0/src/./../include/dh.h:33: undefined reference to `DH_set0_pqg&#39;</span>
</span></span><span class="line"><span class="cl">collect2: error: ld returned <span class="m">1</span> <span class="nb">exit</span> status
</span></span><span class="line"><span class="cl">make<span class="o">[</span>1<span class="o">]</span>: *** <span class="o">[</span>nrpe<span class="o">]</span> Error <span class="m">1</span>
</span></span><span class="line"><span class="cl">make<span class="o">[</span>1<span class="o">]</span>: Leaving directory <span class="sb">`</span>/tmp/nrpe-4.1.0/src<span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">make: *** [all] Error 2
</span></span></span><span class="line"><span class="cl"><span class="s1">...
</span></span></span><span class="line"><span class="cl"><span class="s1">undefined reference to `SSL_get1_peer_certificate&#39;</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>nagios</code> 依赖 <code>apache</code> 提供的 <code>httpd</code>，管理页面位于: http://127.0.0.1:80/nagios/。</p>
</li>
<li>
<p><code>NRPE</code> 的服务端不需要安装以下功能：</p>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## below only for host-client</span>
</span></span><span class="line"><span class="cl"><span class="c1">## make install-config &amp;&amp; \</span>
</span></span><span class="line"><span class="cl"><span class="c1">## make install-inetd &amp;&amp; \</span>
</span></span><span class="line"><span class="cl"><span class="c1">## make install-init &amp;&amp; \</span>
</span></span><span class="line"><span class="cl"><span class="c1">## make install-groups-users</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>nagcmd</code> 用户</p>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">groupadd nagcmd
</span></span><span class="line"><span class="cl">usermod -G nagcmd nagios
</span></span><span class="line"><span class="cl">usermod -G nagcmd apache
</span></span><span class="line"><span class="cl">chown nagios:nagcmd /usr/local/nagios/var/rw
</span></span><span class="line"><span class="cl">chown nagios:nagcmd /usr/local/nagios/var/rw/nagios.cmd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">systemctl restart nagios</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>perl</code> 实现命令行自动安装依赖包</p>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># export PERL_MM_USE_DEFAULT=1 &amp;&amp; \</span>
</span></span><span class="line"><span class="cl"><span class="c1"># # cpan -i Digest::MD5 &amp;&amp; \</span>
</span></span><span class="line"><span class="cl"><span class="c1"># # cpan -i Nagios::Config &amp;&amp; \</span>
</span></span><span class="line"><span class="cl"><span class="c1"># perl -MCPAN -e &#34;install Digest::MD5&#34;  &amp;&amp; \</span>
</span></span><span class="line"><span class="cl"><span class="c1"># perl -MCPAN -e &#34;install Nagios::Config&#34;  &amp;&amp; \</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">yum -y install perl-App-cpanminus.noarch
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PERL_CPANM_OPT</span><span class="o">=</span><span class="s2">&#34;--prompt --reinstall -l ~/perl5 --mirror http://cpan.cpantesters.org&#34;</span>
</span></span><span class="line"><span class="cl">cpanm Digest::MD5
</span></span><span class="line"><span class="cl">cpanm Nagios::Config</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在安装 <code>nagios-graph</code> 的时候，一定要注意允许修改 <code>nagios.cfg</code></p>
<ul>
<li>
<p><code>nagios.cfg</code></p>
<div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Modify the Nagios configuration? <span class="o">[</span>n<span class="o">]</span> y
</span></span><span class="line"><span class="cl">Path of Nagios configuration file? <span class="o">[</span>/usr/local/nagios/etc/nagios.cfg<span class="o">]</span>
</span></span><span class="line"><span class="cl">Path of Nagios commands file? <span class="o">[</span>/usr/local/nagios/etc/objects/commands.cfg<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="sb">```</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><code>apache</code></p>
<div class="highlight" id="id-6"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Modify the Apache configuration? <span class="o">[</span>n<span class="o">]</span> y
</span></span><span class="line"><span class="cl">Path of Apache configuration directory? <span class="o">[</span>/etc/httpd/conf.d<span class="o">]</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>整个过程如下：</p>
<div class="highlight" id="id-7"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">checking required PERL modules
</span></span><span class="line"><span class="cl">  Carp...1.26
</span></span><span class="line"><span class="cl">  CGI...3.63
</span></span><span class="line"><span class="cl">  Data::Dumper...2.145
</span></span><span class="line"><span class="cl">  Digest::MD5...2.52
</span></span><span class="line"><span class="cl">  File::Basename...2.84
</span></span><span class="line"><span class="cl">  File::Find...1.20
</span></span><span class="line"><span class="cl">  MIME::Base64...3.13
</span></span><span class="line"><span class="cl">  POSIX...1.30
</span></span><span class="line"><span class="cl">  RRDs...1.4008
</span></span><span class="line"><span class="cl">  Time::HiRes...1.9725
</span></span><span class="line"><span class="cl">checking optional PERL modules
</span></span><span class="line"><span class="cl">  GD...2.49
</span></span><span class="line"><span class="cl">  Nagios::Config...36
</span></span><span class="line"><span class="cl">checking nagios installation
</span></span><span class="line"><span class="cl">  found nagios exectuable at /usr/local/nagios/bin/nagios
</span></span><span class="line"><span class="cl">  found nagios init script at /etc/init.d/nagios
</span></span><span class="line"><span class="cl">checking web server installation
</span></span><span class="line"><span class="cl">  found apache executable at /usr/sbin/httpd
</span></span><span class="line"><span class="cl">Destination directory <span class="o">(</span>prefix<span class="o">)</span>? <span class="o">[</span>/usr/local/nagios<span class="o">]</span>
</span></span><span class="line"><span class="cl">Location of configuration files <span class="o">(</span>etc-dir<span class="o">)</span>? <span class="o">[</span>/usr/local/nagios/etc/nagiosgraph<span class="o">]</span>
</span></span><span class="line"><span class="cl">Location of executables? <span class="o">[</span>/usr/local/nagios/libexec<span class="o">]</span>
</span></span><span class="line"><span class="cl">Location of CGI scripts? <span class="o">[</span>/usr/local/nagios/sbin<span class="o">]</span>
</span></span><span class="line"><span class="cl">Location of documentation <span class="o">(</span>doc-dir<span class="o">)</span>? <span class="o">[</span>/usr/local/nagios/docs/nagiosgraph<span class="o">]</span>
</span></span><span class="line"><span class="cl">Location of examples? <span class="o">[</span>/usr/local/nagios/docs/nagiosgraph/examples<span class="o">]</span>
</span></span><span class="line"><span class="cl">Location of CSS and JavaScript files? <span class="o">[</span>/usr/local/nagios/share<span class="o">]</span>
</span></span><span class="line"><span class="cl">Location of utilities? <span class="o">[</span>/usr/local/nagios/docs/nagiosgraph/util<span class="o">]</span>
</span></span><span class="line"><span class="cl">Location of state files <span class="o">(</span>var-dir<span class="o">)</span>? <span class="o">[</span>/var/nagios<span class="o">]</span>
</span></span><span class="line"><span class="cl">Location of RRD files? <span class="o">[</span>/var/nagios/rrd<span class="o">]</span>
</span></span><span class="line"><span class="cl">Location of log files <span class="o">(</span>log-dir<span class="o">)</span>? <span class="o">[</span>/var/nagios<span class="o">]</span>
</span></span><span class="line"><span class="cl">Path of log file? <span class="o">[</span>/var/nagios/nagiosgraph.log<span class="o">]</span>
</span></span><span class="line"><span class="cl">Path of CGI log file? <span class="o">[</span>/var/nagios/nagiosgraph-cgi.log<span class="o">]</span>
</span></span><span class="line"><span class="cl">Base URL? <span class="o">[</span>/nagios<span class="o">]</span>
</span></span><span class="line"><span class="cl">URL of CGI scripts? <span class="o">[</span>/nagios/cgi-bin<span class="o">]</span>
</span></span><span class="line"><span class="cl">URL of CSS file? <span class="o">[</span>/nagios/nagiosgraph.css<span class="o">]</span>
</span></span><span class="line"><span class="cl">URL of JavaScript file? <span class="o">[</span>/nagios/nagiosgraph.js<span class="o">]</span>
</span></span><span class="line"><span class="cl">URL of Nagios CGI scripts? <span class="o">[</span>/nagios/cgi-bin<span class="o">]</span>
</span></span><span class="line"><span class="cl">Path of Nagios performance data file? <span class="o">[</span>/tmp/perfdata.log<span class="o">]</span>
</span></span><span class="line"><span class="cl">username or userid of Nagios user? <span class="o">[</span>nagios<span class="o">]</span>
</span></span><span class="line"><span class="cl">username or userid of web server user? <span class="o">[</span>apache<span class="o">]</span>
</span></span><span class="line"><span class="cl">Modify the Nagios configuration? <span class="o">[</span>n<span class="o">]</span> y
</span></span><span class="line"><span class="cl">Path of Nagios configuration file? <span class="o">[</span>/usr/local/nagios/etc/nagios.cfg<span class="o">]</span>
</span></span><span class="line"><span class="cl">Path of Nagios commands file? <span class="o">[</span>/usr/local/nagios/etc/objects/commands.cfg<span class="o">]</span>
</span></span><span class="line"><span class="cl">Modify the Apache configuration? <span class="o">[</span>n<span class="o">]</span> y
</span></span><span class="line"><span class="cl">Path of Apache configuration directory? <span class="o">[</span>/etc/httpd/conf.d<span class="o">]</span>
</span></span><span class="line"><span class="cl">configuration:
</span></span><span class="line"><span class="cl">  ng_prefix            /usr/local/nagios
</span></span><span class="line"><span class="cl">  ng_etc_dir           /usr/local/nagios/etc/nagiosgraph
</span></span><span class="line"><span class="cl">  ng_bin_dir           /usr/local/nagios/libexec
</span></span><span class="line"><span class="cl">  ng_cgi_dir           /usr/local/nagios/sbin
</span></span><span class="line"><span class="cl">  ng_doc_dir           /usr/local/nagios/docs/nagiosgraph
</span></span><span class="line"><span class="cl">  ng_examples_dir      /usr/local/nagios/docs/nagiosgraph/examples
</span></span><span class="line"><span class="cl">  ng_www_dir           /usr/local/nagios/share
</span></span><span class="line"><span class="cl">  ng_util_dir          /usr/local/nagios/docs/nagiosgraph/util
</span></span><span class="line"><span class="cl">  ng_var_dir           /var/nagios
</span></span><span class="line"><span class="cl">  ng_rrd_dir           /var/nagios/rrd
</span></span><span class="line"><span class="cl">  ng_log_dir           /var/nagios
</span></span><span class="line"><span class="cl">  ng_log_file          /var/nagios/nagiosgraph.log
</span></span><span class="line"><span class="cl">  ng_cgilog_file       /var/nagios/nagiosgraph-cgi.log
</span></span><span class="line"><span class="cl">  ng_url               /nagios
</span></span><span class="line"><span class="cl">  ng_cgi_url           /nagios/cgi-bin
</span></span><span class="line"><span class="cl">  ng_css_url           /nagios/nagiosgraph.css
</span></span><span class="line"><span class="cl">  ng_js_url            /nagios/nagiosgraph.js
</span></span><span class="line"><span class="cl">  nagios_cgi_url       /nagios/cgi-bin
</span></span><span class="line"><span class="cl">  nagios_perfdata_file /tmp/perfdata.log
</span></span><span class="line"><span class="cl">  nagios_user          nagios
</span></span><span class="line"><span class="cl">  www_user             apache
</span></span><span class="line"><span class="cl">  modify_nagios_config y
</span></span><span class="line"><span class="cl">  nagios_config_file   /usr/local/nagios/etc/nagios.cfg
</span></span><span class="line"><span class="cl">  nagios_commands_file /usr/local/nagios/etc/objects/commands.cfg
</span></span><span class="line"><span class="cl">  modify_apache_config y
</span></span><span class="line"><span class="cl">  apache_config_dir    /etc/httpd/conf.d
</span></span><span class="line"><span class="cl">  apache_config_file
</span></span><span class="line"><span class="cl">Continue with this configuration? <span class="o">[</span>y<span class="o">]</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>需要修改 <code>rrd</code> 的权限，否则会报错：no data found in /var/nagios/rrd</p>
<div class="highlight" id="id-8"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## -------------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 修改权限</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 解决 no data in /var/nagios/rrd</span>
</span></span><span class="line"><span class="cl"><span class="c1"># chmod -R 777 /usr/local/nagios</span>
</span></span><span class="line"><span class="cl">chmod -R <span class="m">777</span> /var/nagios</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h1 id="服务端" class="heading-element">
  <a href="#%e6%9c%8d%e5%8a%a1%e7%ab%af" class="heading-mark"></a>服务端</h1><h2 id="安装-nagios-core" class="heading-element">
  <a href="#%e5%ae%89%e8%a3%85-nagios-core" class="heading-mark"></a>安装 nagios-core</h2><div class="highlight" id="id-9"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo yum -y install httpd php gd gd-devel perl postfix <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    yum -y install perl perl-CGI <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sudo useradd nagios -p nagios <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sudo groupadd nagcmd <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sudo usermod -G nagcmd nagios <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    sudo usermod -G nagcmd apache
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">NAGIOS_CORE_VERSION</span><span class="o">=</span>4.4.13
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /tmp <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    wget -O nagioscore.tar.gz https://github.com/NagiosEnterprises/nagioscore/archive/nagios-<span class="si">${</span><span class="nv">NAGIOS_CORE_VERSION</span><span class="si">}</span>.tar.gz <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    tar -xvf nagioscore.tar.gz <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nb">cd</span> nagioscore-nagios-<span class="si">${</span><span class="nv">NAGIOS_CORE_VERSION</span><span class="si">}</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    ./configure <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make all <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make install <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make install-daemoninit <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make install-config <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make install-commandmode <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make install-webconf</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="安装-nagios-plugin" class="heading-element">
  <a href="#%e5%ae%89%e8%a3%85-nagios-plugin" class="heading-mark"></a>安装 nagios-plugin</h2><div class="highlight" id="id-10"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">NAGIOS_PLUGIN_VERSION</span><span class="o">=</span>2.4.5
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /tmp <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    wget --no-check-certificate -O nagios-plugins.tar.gz https://github.com/nagios-plugins/nagios-plugins/releases/download/release-<span class="si">${</span><span class="nv">NAGIOS_PLUGIN_VERSION</span><span class="si">}</span>/nagios-plugins-<span class="si">${</span><span class="nv">NAGIOS_PLUGIN_VERSION</span><span class="si">}</span>.tar.gz <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    tar -xvf nagios-plugins.tar.gz <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nb">cd</span> nagios-plugins-<span class="si">${</span><span class="nv">NAGIOS_PLUGIN_VERSION</span><span class="si">}</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nb">unset</span> ZSH_VERSION <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nv">CFLAGS</span><span class="o">=</span><span class="s2">&#34;-I/usr/local/openssl/include&#34;</span> <span class="nv">LDFLAGS</span><span class="o">=</span><span class="s2">&#34;-L/usr/local/openssl/lib64&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    ./configure --with-nagios-user<span class="o">=</span>nagios --with-nagios-group<span class="o">=</span>nagios --with-openssl<span class="o">=</span>/usr/local/openssl <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make -j <span class="o">&amp;&amp;</span> make install</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="安装-nagios-nrpe" class="heading-element">
  <a href="#%e5%ae%89%e8%a3%85-nagios-nrpe" class="heading-mark"></a>安装 nagios-nrpe</h2><div class="highlight" id="id-11"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">NAGIOS_NRPE_VERSION</span><span class="o">=</span>4.1.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /tmp <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nb">unset</span> ZSH_VERSION <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    wget https://www.openssl.org/source/old/1.1.1/openssl-1.1.1t.tar.gz <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    tar -xvf openssl-1.1.1t.tar.gz <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nb">cd</span> openssl-1.1.1t <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    ./config --prefix<span class="o">=</span>/usr/local --openssldir<span class="o">=</span>/etc/ssl --libdir<span class="o">=</span>lib enable-ssl3 enable-ssl3-method enable-weak-ssl-ciphers -DOPENSSL_NO_GOST zlib shared <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make -j <span class="o">&amp;&amp;</span> make install  <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    ln -sfn /usr/local/bin/openssl /usr/bin/openssl <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    ln -sfn /usr/local/include/openssl/ /usr/include/openssl <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nb">echo</span> <span class="s2">&#34;/usr/local/lib/&#34;</span> &gt;&gt; /etc/ld.so.conf <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    ldconfig <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    wget --no-check-certificate -O nagios-nrpe.tar.gz https://github.com/NagiosEnterprises/nrpe/releases/download/nrpe-<span class="si">${</span><span class="nv">NAGIOS_NRPE_VERSION</span><span class="si">}</span>/nrpe-<span class="si">${</span><span class="nv">NAGIOS_NRPE_VERSION</span><span class="si">}</span>.tar.gz <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    tar -xvf nagios-nrpe.tar.gz <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nb">cd</span> nrpe-<span class="si">${</span><span class="nv">NAGIOS_NRPE_VERSION</span><span class="si">}</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nb">export</span> <span class="nv">LDFLAGS</span><span class="o">=</span>-L/usr/local/lib <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    ./configure --enable-command-args --with-nagios-user<span class="o">=</span>nagios --with-nagios-group<span class="o">=</span>nagios <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make all <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make install <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="c1">## below only for host-client</span>
</span></span><span class="line"><span class="cl">    <span class="c1">## make install-config &amp;&amp; \</span>
</span></span><span class="line"><span class="cl">    <span class="c1">## make install-inetd &amp;&amp; \</span>
</span></span><span class="line"><span class="cl">    <span class="c1">## make install-init &amp;&amp; \</span>
</span></span><span class="line"><span class="cl">    <span class="c1">## make install-groups-users</span>
</span></span><span class="line"><span class="cl">    rm -rf /tmp/nagios*</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="启动服务" class="heading-element">
  <a href="#%e5%90%af%e5%8a%a8%e6%9c%8d%e5%8a%a1" class="heading-mark"></a>启动服务</h2><div class="highlight" id="id-12"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## 启动 http 服务</span>
</span></span><span class="line"><span class="cl">sudo systemctl restart httpd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 生成密码</span>
</span></span><span class="line"><span class="cl">sudo htpasswd -c /usr/local/nagios/etc/htpasswd.users nagiosadmin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">New password:
</span></span><span class="line"><span class="cl">Re-type new password:
</span></span><span class="line"><span class="cl">Adding password <span class="k">for</span> user nagiosadmin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 启动服务</span>
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> nagios
</span></span><span class="line"><span class="cl">systemctl start nagios
</span></span><span class="line"><span class="cl">systemctl status nagios
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 开放端口</span>
</span></span><span class="line"><span class="cl"><span class="c1">#firewall-cmd --add-service=http</span>
</span></span><span class="line"><span class="cl"><span class="c1">#firewall-cmd --add-service=https</span>
</span></span><span class="line"><span class="cl"><span class="c1">#firewall-cmd --reload</span></span></span></code></pre></td></tr></table>
</div>
</div><p>检查一下插件是否已经安装好</p>
<div class="highlight" id="id-13"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1">## 远程服务在 192.168.1.162:5666</span>
</span></span><span class="line"><span class="cl">/usr/local/nagios/libexec/check_nrpe -H 192.168.1.162 -p <span class="m">5666</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 这时候会调用远程客户端命令，如果显示以下内容则说明匹配成功了</span>
</span></span><span class="line"><span class="cl">NRPE v4.0.3</span></span></code></pre></td></tr></table>
</div>
</div><p>这样，可以访问: http://127.0.0.1:80/nagios/。</p>
<div class="highlight" id="id-14"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">&lt;!DOCTYPE HTML PUBLIC <span class="s2">&#34;-//IETF//DTD HTML 2.0//EN&#34;</span>&gt;
</span></span><span class="line"><span class="cl">&lt;html&gt;&lt;head&gt;
</span></span><span class="line"><span class="cl">&lt;title&gt;401 Unauthorized&lt;/title&gt;
</span></span><span class="line"><span class="cl">&lt;/head&gt;&lt;body&gt;
</span></span><span class="line"><span class="cl">&lt;h1&gt;Unauthorized&lt;/h1&gt;
</span></span><span class="line"><span class="cl">&lt;p&gt;This server could not verify that you
</span></span><span class="line"><span class="cl">are authorized to access the document
</span></span><span class="line"><span class="cl">requested.  Either you supplied the wrong
</span></span><span class="line"><span class="cl">credentials <span class="o">(</span>e.g., bad password<span class="o">)</span>, or your
</span></span><span class="line"><span class="cl">browser doesn<span class="err">&#39;</span>t understand how to supply
</span></span><span class="line"><span class="cl">the credentials required.&lt;/p&gt;
</span></span><span class="line"><span class="cl">&lt;/body&gt;&lt;/html&gt;</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="添加监控客户机器" class="heading-element">
  <a href="#%e6%b7%bb%e5%8a%a0%e7%9b%91%e6%8e%a7%e5%ae%a2%e6%88%b7%e6%9c%ba%e5%99%a8" class="heading-mark"></a>添加监控客户机器</h2><p>可以参考 <code>/usr/local/nagios/etc/objects/localhost.cfg</code>， 比如这个客户端 <code>/usr/local/nagios/etc/research-machines/m2.cfg</code></p>
<div class="highlight" id="id-15"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 中间的内容块是用于设置设备信息的</span>
</span></span><span class="line"><span class="cl">define host <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># use 关键字表示使用的模版，模版将在后续讲解，此处使用的是 linux-server 模版</span>
</span></span><span class="line"><span class="cl">    use                             linux-server
</span></span><span class="line"><span class="cl">    <span class="c1"># host_name 关键字表示机器的名字，也是在 Web 界面中显示的名字</span>
</span></span><span class="line"><span class="cl">    host_name                       M2
</span></span><span class="line"><span class="cl">    <span class="c1"># alias 表示机器的别名，一般用作机器别名的描述</span>
</span></span><span class="line"><span class="cl">    <span class="nb">alias</span>                           M2@WuyaCapital
</span></span><span class="line"><span class="cl">    <span class="c1"># address 设置该机器的 IP 地址，以便与数据的获取与被动监控的请求</span>
</span></span><span class="line"><span class="cl">    address                         192.168.1.162
</span></span><span class="line"><span class="cl">    <span class="c1"># 最大的尝试次数，也就是在某服务监控出错再次运行监控命令获取数据的次数</span>
</span></span><span class="line"><span class="cl">    max_check_attempts              <span class="m">3</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 检测的时间段</span>
</span></span><span class="line"><span class="cl">    check_period                    24x7
</span></span><span class="line"><span class="cl">    <span class="c1"># 发送消息提醒的时间间隔</span>
</span></span><span class="line"><span class="cl">    notification_interval           <span class="m">30</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 发送消息提醒的时间段</span>
</span></span><span class="line"><span class="cl">    notification_period             24x7
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">define service<span class="o">{</span>
</span></span><span class="line"><span class="cl">    use                             local-service,graphed-service         <span class="p">;</span> Name of service template to use
</span></span><span class="line"><span class="cl">    host_name                       M2
</span></span><span class="line"><span class="cl">    service_description             Current Users
</span></span><span class="line"><span class="cl">    check_command                   check_nrpe!check_users
</span></span><span class="line"><span class="cl">    check_interval                  <span class="m">1</span>
</span></span><span class="line"><span class="cl">    retry_interval                  <span class="m">1</span>
</span></span><span class="line"><span class="cl">    check_period                    24x7
</span></span><span class="line"><span class="cl">    notification_interval           <span class="m">1</span>
</span></span><span class="line"><span class="cl">    notification_period             24x7
</span></span><span class="line"><span class="cl">    notifications_enabled           <span class="m">1</span>
</span></span><span class="line"><span class="cl">    register                        <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">define service<span class="o">{</span>
</span></span><span class="line"><span class="cl">    use                             local-service,graphed-service         <span class="p">;</span> Name of service template to use
</span></span><span class="line"><span class="cl">    host_name                       M2
</span></span><span class="line"><span class="cl">    service_description             Total Procs
</span></span><span class="line"><span class="cl">    check_command                   check_nrpe!check_total_procs
</span></span><span class="line"><span class="cl">    check_interval                  <span class="m">1</span>
</span></span><span class="line"><span class="cl">    retry_interval                  <span class="m">1</span>
</span></span><span class="line"><span class="cl">    check_period                    24x7
</span></span><span class="line"><span class="cl">    notification_interval           <span class="m">1</span>
</span></span><span class="line"><span class="cl">    notification_period             24x7
</span></span><span class="line"><span class="cl">    notifications_enabled           <span class="m">1</span>
</span></span><span class="line"><span class="cl">    register                        <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>同时，我们需要修改命令</p>
<div class="highlight" id="id-16"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vim /usr/local/nagios/etc/objects/commands.cfg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># &#39;check_NRPE&#39; command definition</span>
</span></span><span class="line"><span class="cl">define command<span class="o">{</span>
</span></span><span class="line"><span class="cl">    command_name check_nrpe
</span></span><span class="line"><span class="cl">    command_line <span class="nv">$USER1</span>$/check_nrpe -H <span class="nv">$HOSTADDRESS</span>$ -p <span class="nv">$ARG1</span>$ -c <span class="nv">$ARG2</span>$
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h1 id="客户端" class="heading-element">
  <a href="#%e5%ae%a2%e6%88%b7%e7%ab%af" class="heading-mark"></a>客户端</h1><div class="highlight" id="id-17"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo yum -y install zlib-devel xinetd
</span></span><span class="line"><span class="cl">sudo useradd nagios -p nagios</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="安装-nagios-plugin-1" class="heading-element">
  <a href="#%e5%ae%89%e8%a3%85-nagios-plugin-1" class="heading-mark"></a>安装 nagios-plugin</h2><p>同服务端的安装: <a href="#%e5%ae%89%e8%a3%85-nagios-plugin">nagios-plugin</a></p>
<h2 id="安装-nagios-nrpe-1" class="heading-element">
  <a href="#%e5%ae%89%e8%a3%85-nagios-nrpe-1" class="heading-mark"></a>安装 nagios-nrpe</h2><div class="highlight" id="id-18"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">NAGIOS_NRPE_VERSION</span><span class="o">=</span>4.1.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /tmp <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nb">unset</span> ZSH_VERSION <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    wget https://www.openssl.org/source/old/1.1.1/openssl-1.1.1t.tar.gz <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    tar -xvf openssl-1.1.1t.tar.gz <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nb">cd</span> openssl-1.1.1t <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    ./config --prefix<span class="o">=</span>/usr/local --openssldir<span class="o">=</span>/etc/ssl --libdir<span class="o">=</span>lib enable-ssl3 enable-ssl3-method enable-weak-ssl-ciphers -DOPENSSL_NO_GOST zlib shared <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make -j <span class="o">&amp;&amp;</span> make install  <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    ln -sfn /usr/local/bin/openssl /usr/bin/openssl <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    ln -sfn /usr/local/include/openssl/ /usr/include/openssl <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nb">echo</span> <span class="s2">&#34;/usr/local/lib/&#34;</span> &gt;&gt; /etc/ld.so.conf <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    ldconfig <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    wget --no-check-certificate -O nagios-nrpe.tar.gz https://github.com/NagiosEnterprises/nrpe/releases/download/nrpe-<span class="si">${</span><span class="nv">NAGIOS_NRPE_VERSION</span><span class="si">}</span>/nrpe-<span class="si">${</span><span class="nv">NAGIOS_NRPE_VERSION</span><span class="si">}</span>.tar.gz <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    tar -xvf nagios-nrpe.tar.gz <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nb">cd</span> nrpe-<span class="si">${</span><span class="nv">NAGIOS_NRPE_VERSION</span><span class="si">}</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="nb">export</span> <span class="nv">LDFLAGS</span><span class="o">=</span>-L/usr/local/lib <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    ./configure --enable-command-args --with-nagios-user<span class="o">=</span>nagios --with-nagios-group<span class="o">=</span>nagios <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make all <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make install <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    <span class="c1">## below only for host-client</span>
</span></span><span class="line"><span class="cl">    make install-config <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make install-inetd <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make install-init <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    make install-groups-users
</span></span><span class="line"><span class="cl">    rm -rf /tmp/nagios*</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="启动服务-1" class="heading-element">
  <a href="#%e5%90%af%e5%8a%a8%e6%9c%8d%e5%8a%a1-1" class="heading-mark"></a>启动服务</h2><div class="highlight" id="id-19"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">systemctl <span class="nb">enable</span> xinetd
</span></span><span class="line"><span class="cl">systemctl restart xinetd
</span></span><span class="line"><span class="cl">systemctl status xinetd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> nrpe
</span></span><span class="line"><span class="cl">systemctl restart nrpe
</span></span><span class="line"><span class="cl">systemctl status nrpe
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 检查是否已经启动 nrpe</span>
</span></span><span class="line"><span class="cl">netstat -at <span class="p">|</span> egrep <span class="s2">&#34;nrpe|5666&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 检查服务是否启程</span>
</span></span><span class="line"><span class="cl">/usr/local/nagios/libexec/check_nrpe -H localhost
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NRPE v4.1.0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 检查插件是否可用</span>
</span></span><span class="line"><span class="cl">/usr/local/nagios/libexec/check_nrpe -H localhost -c check_users
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">USERS OK - <span class="m">5</span> users currently logged in <span class="p">|</span><span class="nv">users</span><span class="o">=</span>5<span class="p">;</span>5<span class="p">;</span>10<span class="p">;</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 修改客户端监控项目与内容</span>
</span></span><span class="line"><span class="cl">vim /usr/local/nagios/etc/nrpe.cfg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The following examples allow user-supplied arguments and can</span>
</span></span><span class="line"><span class="cl"><span class="c1"># only be used if the NRPE daemon was compiled with support for</span>
</span></span><span class="line"><span class="cl"><span class="c1"># command arguments *AND* the dont_blame_nrpe directive in this</span>
</span></span><span class="line"><span class="cl"><span class="c1"># config file is set to &#39;1&#39;.  This poses a potential security risk, so</span>
</span></span><span class="line"><span class="cl"><span class="c1"># make sure you read the SECURITY file before doing this.</span>
</span></span><span class="line"><span class="cl"><span class="c1">### MISC SYSTEM METRICS ###</span>
</span></span><span class="line"><span class="cl"><span class="c1"># command[check_users]=/usr/local/nagios/libexec/check_users -w 5 -c 10</span>
</span></span><span class="line"><span class="cl">command<span class="o">[</span>check_load<span class="o">]=</span>/usr/local/nagios/libexec/check_load -r -w .15,.10,.05 -c .30,.25,.20
</span></span><span class="line"><span class="cl">command<span class="o">[</span>check_hda1<span class="o">]=</span>/usr/local/nagios/libexec/check_disk -w 20% -c 10% -p /dev/hda1
</span></span><span class="line"><span class="cl">command<span class="o">[</span>check_zombie_procs<span class="o">]=</span>/usr/local/nagios/libexec/check_procs -w <span class="m">5</span> -c <span class="m">10</span> -s Z
</span></span><span class="line"><span class="cl">command<span class="o">[</span>check_total_procs<span class="o">]=</span>/usr/local/nagios/libexec/check_procs -w <span class="m">150</span> -c <span class="m">200</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The following examples allow user-supplied arguments and can</span>
</span></span><span class="line"><span class="cl"><span class="c1"># only be used if the NRPE daemon was compiled with support for</span>
</span></span><span class="line"><span class="cl"><span class="c1"># command arguments *AND* the dont_blame_nrpe directive in this</span>
</span></span><span class="line"><span class="cl"><span class="c1"># config file is set to &#39;1&#39;.  This poses a potential security risk, so</span>
</span></span><span class="line"><span class="cl"><span class="c1"># make sure you read the SECURITY file before doing this.</span>
</span></span><span class="line"><span class="cl"><span class="c1">### MISC SYSTEM METRICS ###</span>
</span></span><span class="line"><span class="cl">command<span class="o">[</span>check_users<span class="o">]=</span>/usr/local/nagios/libexec/check_users -w <span class="nv">$ARG1</span>$ -c <span class="nv">$ARG2</span>$
</span></span><span class="line"><span class="cl"><span class="c1">#command[check_load]=/usr/local/nagios/libexec/check_load $ARG1$</span>
</span></span><span class="line"><span class="cl"><span class="c1">#command[check_disk]=/usr/local/nagios/libexec/check_disk $ARG1$</span>
</span></span><span class="line"><span class="cl"><span class="c1">#command[check_swap]=/usr/local/nagios/libexec/check_swap $ARG1$</span>
</span></span><span class="line"><span class="cl"><span class="c1">#command[check_cpu_stats]=/usr/local/nagios/libexec/check_cpu_stats.sh $ARG1$</span>
</span></span><span class="line"><span class="cl"><span class="c1">#command[check_mem]=/usr/local/nagios/libexec/custom_check_mem -n $ARG1$</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 允许接入的服务器ip</span>
</span></span><span class="line"><span class="cl"><span class="nv">allowed_hosts</span><span class="o">=</span>127.0.0.1
</span></span><span class="line"><span class="cl"><span class="nv">allowed_hosts</span><span class="o">=</span>192.168.1.162
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 日志文件</span>
</span></span><span class="line"><span class="cl"><span class="nv">log_file</span><span class="o">=</span>/usr/local/nagios/var/nrpe.log
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 允许传递参数</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 这样服务器可以调用参数：/usr/local/nagios/libexec/check_nrpe -H127.0.0.1 -p56118 -c check_users -a &#34;2 10&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 在 command.cfg 可以这样使用参数传递：command_line $USER1$/check_nrpe -H $HOSTADDRESS$ -p $ARG1$ -c $ARG2$ -a $ARG3$</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 在 colo.cfg 调用命令：check_command check_nrpe!56118!check_users!&#34;2 10&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">##</span>
</span></span><span class="line"><span class="cl"><span class="nv">dont_blame_nrpe</span><span class="o">=</span><span class="m">1</span></span></span></code></pre></td></tr></table>
</div>
</div><h1 id="编写-nagios-plugin" class="heading-element">
  <a href="#%e7%bc%96%e5%86%99-nagios-plugin" class="heading-mark"></a>编写 nagios-plugin</h1><h2 id="show-users" class="heading-element">
  <a href="#show-users" class="heading-mark"></a>show-users</h2><ul>
<li><a href="https://exchange.nagios.org/directory/Plugins/System-Metrics/Users/Show-Users/details"target="_blank" rel="external nofollow noopener noreferrer">Show Users<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://exchange.nagios.org/directory/Plugins/Operating-Systems/Linux/show_users/details"target="_blank" rel="external nofollow noopener noreferrer">show_users<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://exchange.nagios.org/components/com_mtree/attachment.php?link_id=3497&amp;cf_id=24"target="_blank" rel="external nofollow noopener noreferrer">show_users.sh<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ul>
<h3 id="代码" class="heading-element">
  <a href="#%e4%bb%a3%e7%a0%81" class="heading-mark"></a>代码</h3><div class="highlight" id="id-20"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   Copyright Hari Sekhon 2007</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   This program is free software; you can redistribute it and/or modify</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   it under the terms of the GNU General Public License as published by</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   the Free Software Foundation; either version 2 of the License, or</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   (at your option) any later version.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   This program is distributed in the hope that it will be useful,</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   GNU General Public License for more details.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   You should have received a copy of the GNU General Public License</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   along with this program; if not, write to the Free Software</span>
</span></span><span class="line"><span class="cl"><span class="c1">#   Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Nagios Plugin to list all currently logged on users to a system.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Modified by Rob MacKenzie, SFU - rmackenz@sfu.ca</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Added the -w and -c options to check for number of users.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">version</span><span class="o">=</span>0.3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># This makes coding much safer as a varible typo is caught</span>
</span></span><span class="line"><span class="cl"><span class="c1"># with an error rather than passing through</span>
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -u
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Note: resisted urge to use &lt;&lt;&lt;, instead sticking with |</span>
</span></span><span class="line"><span class="cl"><span class="c1"># in case anyone uses this with an older version of bash</span>
</span></span><span class="line"><span class="cl"><span class="c1"># so no bash bashers please on this</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Standard Nagios exit codes</span>
</span></span><span class="line"><span class="cl"><span class="nv">OK</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">WARNING</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">CRITICAL</span><span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="nv">UNKNOWN</span><span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">usage<span class="o">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;usage: </span><span class="si">${</span><span class="nv">0</span><span class="p">##*/</span><span class="si">}</span><span class="s2"> [--simple] [ --mandatory username ] [ --unauthorized username ] [ --whitelist username ]&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;returns a list of users on the local machine&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;   -s, --simple show users without the number of sessions&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;   -m username, --mandatory username&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                Mandatory users. Return CRITICAL if any of these users are not&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                currently logged in&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;   -b username, --blacklist username&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                Unauthorized users. Returns CRITICAL if any of these users are&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                logged in. This can be useful if you have a policy that states&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                that you may not have a root shell but must instead only use &#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                &#39;sudo command&#39;. Specifying &#39;-u root&#39; would alert on root having&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                a session and hence catch people violating such a policy.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;   -a username, --whitelist username&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                Whitelist users. This is exceptionally useful. If you define&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                a bunch of users here that you know you use, and suddenly&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                there is a user session open for another account it could&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                alert you to a compromise. If you run this check say every&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                3 minutes, then any attacker has very little time to evade&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                detection before this trips.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                -m,-u and -w can be specified multiple times for multiple users&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                or you can use a switch a single time with a comma separated&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                list.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;   -w integer, --warning integer&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                Set WARNING status if more than INTEGER users are logged in&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;   -c integer, --critical integer&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;                Set CRITICAL status if more than INTEGER users are logged in&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;   -V --version Print the version number and exit&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="nv">$UNKNOWN</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">simple</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">mandatory_users</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">unauthorized_users</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">whitelist_users</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">warning_users</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">critical_users</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$#</span><span class="s2">&#34;</span> -ge <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> in
</span></span><span class="line"><span class="cl">-h<span class="p">|</span>--help<span class="o">)</span>  usage
</span></span><span class="line"><span class="cl">                    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">-V<span class="p">|</span>--version<span class="o">)</span>  <span class="nb">echo</span> <span class="nv">$version</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">exit</span> <span class="nv">$UNKNOWN</span>
</span></span><span class="line"><span class="cl">                    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">-s<span class="p">|</span>--simple<span class="o">)</span>  <span class="nv">simple</span><span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl">                    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">-m<span class="p">|</span>--mandatory<span class="o">)</span>  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$#</span><span class="s2">&#34;</span> -ge <span class="m">2</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$mandatory_users</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                            <span class="nv">mandatory_users</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$mandatory_users</span><span class="s2"> </span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span>
</span></span><span class="line"><span class="cl">                            <span class="nv">mandatory_users</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">shift</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span>
</span></span><span class="line"><span class="cl">                        usage
</span></span><span class="line"><span class="cl">                    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">                    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">-b<span class="p">|</span>--blacklist<span class="o">)</span>  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$#</span><span class="s2">&#34;</span> -ge <span class="m">2</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$unauthorized_users</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                            <span class="nv">unauthorized_users</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$unauthorized_users</span><span class="s2"> </span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span>
</span></span><span class="line"><span class="cl">                            <span class="nv">unauthorized_users</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">shift</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span>
</span></span><span class="line"><span class="cl">                        usage
</span></span><span class="line"><span class="cl">                    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">                    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">-a<span class="p">|</span>--whitelist<span class="o">)</span>  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$#</span><span class="s2">&#34;</span> -ge <span class="m">2</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$whitelist_users</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                            <span class="nv">whitelist_users</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$whitelist_users</span><span class="s2"> </span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span>
</span></span><span class="line"><span class="cl">                            <span class="nv">whitelist_users</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">shift</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span>
</span></span><span class="line"><span class="cl">                        usage
</span></span><span class="line"><span class="cl">                    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">                    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">-w<span class="p">|</span>--warning<span class="o">)</span>  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$#</span><span class="s2">&#34;</span> -ge <span class="m">2</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">[</span> <span class="nv">$2</span> -ge <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                            <span class="nv">warning_users</span><span class="o">=</span><span class="nv">$2</span>
</span></span><span class="line"><span class="cl">                        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">shift</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span>
</span></span><span class="line"><span class="cl">                        usage
</span></span><span class="line"><span class="cl">                    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">                    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">-c<span class="p">|</span>--critical<span class="o">)</span>  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$#</span><span class="s2">&#34;</span> -ge <span class="m">2</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="o">[</span> <span class="nv">$2</span> -ge <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                            <span class="nv">critical_users</span><span class="o">=</span><span class="nv">$2</span>
</span></span><span class="line"><span class="cl">                        <span class="k">fi</span>
</span></span><span class="line"><span class="cl">                        <span class="nb">shift</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span>
</span></span><span class="line"><span class="cl">                        usage
</span></span><span class="line"><span class="cl">                    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">                    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">                *<span class="o">)</span>  usage
</span></span><span class="line"><span class="cl">                    <span class="p">;;</span>
</span></span><span class="line"><span class="cl">    <span class="k">esac</span>
</span></span><span class="line"><span class="cl">    <span class="nb">shift</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">mandatory_users</span><span class="o">=</span><span class="s2">&#34;`echo </span><span class="nv">$mandatory_users</span><span class="s2"> | tr &#39;,&#39; &#39; &#39;`&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">unauthorized_users</span><span class="o">=</span><span class="s2">&#34;`echo </span><span class="nv">$unauthorized_users</span><span class="s2"> | tr &#39;,&#39; &#39; &#39;`&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">whitelist_users</span><span class="o">=</span><span class="s2">&#34;`echo </span><span class="nv">$whitelist_users</span><span class="s2"> | tr &#39;,&#39; &#39; &#39;`&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Must be a list of usernames only.</span>
</span></span><span class="line"><span class="cl"><span class="nv">userlist</span><span class="o">=</span><span class="s2">&#34;`who|grep -v &#34;</span>^ *$<span class="s2">&#34;|awk &#39;{print </span><span class="nv">$1</span><span class="s2">}&#39;|sort`&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">usercount</span><span class="o">=</span><span class="s2">&#34;`who|wc -l`&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">errormsg</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">exitcode</span><span class="o">=</span><span class="nv">$OK</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$userlist</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$mandatory_users</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">missing_users</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> user in <span class="nv">$mandatory_users</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> ! <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$userlist</span><span class="s2">&#34;</span><span class="p">|</span>grep <span class="s2">&#34;^</span><span class="nv">$user</span>$<span class="s2">&#34;</span> &gt;/dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                <span class="nv">missing_users</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$missing_users</span><span class="s2"> </span><span class="nv">$user</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">exitcode</span><span class="o">=</span><span class="nv">$CRITICAL</span>
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="k">done</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> user in <span class="sb">`</span><span class="nb">echo</span> <span class="nv">$missing_users</span><span class="p">|</span>tr <span class="s2">&#34; &#34;</span> <span class="s2">&#34;\n&#34;</span><span class="p">|</span>sort -u<span class="sb">`</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">            <span class="nv">errormsg</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">errormsg</span><span class="si">}</span><span class="s2">user &#39;</span><span class="nv">$user</span><span class="s2">&#39; not logged in. &#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$unauthorized_users</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">blacklisted_users</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> user in <span class="nv">$unauthorized_users</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$userlist</span><span class="s2">&#34;</span><span class="p">|</span>sort -u<span class="p">|</span>grep <span class="s2">&#34;^</span><span class="nv">$user</span>$<span class="s2">&#34;</span> &gt;/dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                <span class="nv">blacklisted_users</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$blacklisted_users</span><span class="s2"> </span><span class="nv">$user</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">exitcode</span><span class="o">=</span><span class="nv">$CRITICAL</span>
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="k">done</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> user in <span class="sb">`</span><span class="nb">echo</span> <span class="nv">$blacklisted_users</span><span class="p">|</span>tr <span class="s2">&#34; &#34;</span> <span class="s2">&#34;\n&#34;</span><span class="p">|</span>sort -u<span class="sb">`</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">            <span class="nv">errormsg</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">errormsg</span><span class="si">}</span><span class="s2">Unauthorized user &#39;</span><span class="nv">$user</span><span class="s2">&#39; is logged in! &#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$whitelist_users</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">unwanted_users</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> user in <span class="sb">`</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$userlist</span><span class="s2">&#34;</span><span class="p">|</span>sort -u<span class="sb">`</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> ! <span class="nb">echo</span> <span class="nv">$whitelist_users</span><span class="p">|</span>tr <span class="s2">&#34; &#34;</span> <span class="s2">&#34;\n&#34;</span><span class="p">|</span>grep <span class="s2">&#34;^</span><span class="nv">$user</span>$<span class="s2">&#34;</span> &gt;/dev/null 2&gt;<span class="p">&amp;</span>1<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">                <span class="nv">unwanted_users</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$unwanted_users</span><span class="s2"> </span><span class="nv">$user</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">exitcode</span><span class="o">=</span><span class="nv">$CRITICAL</span>
</span></span><span class="line"><span class="cl">            <span class="k">fi</span>
</span></span><span class="line"><span class="cl">        <span class="k">done</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> user in <span class="sb">`</span><span class="nb">echo</span> <span class="nv">$unwanted_users</span><span class="p">|</span>tr <span class="s2">&#34; &#34;</span> <span class="s2">&#34;\n&#34;</span><span class="p">|</span>sort -u<span class="sb">`</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">            <span class="nv">errormsg</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">errormsg</span><span class="si">}</span><span class="s2">Unauthorized user &#39;</span><span class="nv">$user</span><span class="s2">&#39; detected! &#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="nv">$warning_users</span> -ne <span class="m">0</span> -o <span class="nv">$critical_users</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">	<span class="nv">unwanted_users</span><span class="o">=</span><span class="sb">`</span>who<span class="sb">`</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="o">[</span> <span class="nv">$usercount</span> -ge <span class="nv">$critical_users</span> -a <span class="nv">$critical_users</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">	    <span class="nv">exitcode</span><span class="o">=</span><span class="nv">$CRITICAL</span>
</span></span><span class="line"><span class="cl">	<span class="k">elif</span> <span class="o">[</span> <span class="nv">$usercount</span> -ge <span class="nv">$warning_users</span> -a <span class="nv">$warning_users</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">	    <span class="nv">exitcode</span><span class="o">=</span><span class="nv">$WARNING</span>
</span></span><span class="line"><span class="cl">	<span class="k">fi</span>
</span></span><span class="line"><span class="cl">	<span class="nv">OLDIFS</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$IFS</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nv">IFS</span><span class="o">=</span><span class="s1">$&#39;\n&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> user in <span class="nv">$unwanted_users</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">            <span class="nv">errormsg</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">errormsg</span><span class="si">}</span><span class="s2"> --- </span><span class="nv">$user</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">done</span>
</span></span><span class="line"><span class="cl">	<span class="nv">IFS</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$OLDIFS</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$simple</span><span class="s2">&#34;</span> <span class="o">==</span> <span class="s2">&#34;true&#34;</span> <span class="o">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nv">finallist</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$userlist</span><span class="s2">&#34;</span><span class="p">|</span>uniq<span class="sb">`</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nv">finallist</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$userlist</span><span class="s2">&#34;</span><span class="p">|</span>uniq -c<span class="p">|</span>awk <span class="s1">&#39;{print $2&#34;(&#34;$1&#34;)&#34;}&#39;</span><span class="sb">`</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nv">finallist</span><span class="o">=</span><span class="s2">&#34;no users logged in&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$exitcode</span><span class="s2">&#34;</span> -eq <span class="nv">$OK</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;USERS OK:&#34;</span> <span class="nv">$finallist</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="nv">$OK</span>
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$exitcode</span><span class="s2">&#34;</span> -eq <span class="nv">$WARNING</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;USERS WARNING: [users: &#34;</span><span class="nv">$finallist</span><span class="s2">&#34;]&#34;</span> <span class="nv">$errormsg</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="nv">$WARNING</span>
</span></span><span class="line"><span class="cl"><span class="k">elif</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$exitcode</span><span class="s2">&#34;</span> -eq <span class="nv">$CRITICAL</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;USERS CRITICAL: [users: &#34;</span><span class="nv">$finallist</span><span class="s2">&#34;]&#34;</span> <span class="nv">$errormsg</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="nv">$CRITICAL</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;USERS UNKNOWN:&#34;</span> <span class="nv">$errormsg</span><span class="s2">&#34;[users: &#34;</span><span class="nv">$finallist</span><span class="s2">&#34;]&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="nv">$UNKNOWN</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="nv">$UNKNOWN</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="配置" class="heading-element">
  <a href="#%e9%85%8d%e7%bd%ae" class="heading-mark"></a>配置</h3><div class="highlight" id="id-21"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Plugin worked properly. Just <span class="nb">set</span> below things.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">On Nagios Server:
</span></span><span class="line"><span class="cl">* Create a file <span class="s2">&#34;show_users&#34;</span> in your libexec directory.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* Copy all the <span class="s2">&#34;show_users.txt&#34;</span> contents in <span class="s2">&#34;show_users&#34;</span> file
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* chmod <span class="m">755</span> show_users
</span></span><span class="line"><span class="cl">* chown nagios:nagios show_users
</span></span><span class="line"><span class="cl">* Open your host configuration file <span class="p">&amp;</span> <span class="nb">type</span> below configuration.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">define service<span class="o">{</span>
</span></span><span class="line"><span class="cl">use generic-service <span class="p">;</span> Inherit values from a template
</span></span><span class="line"><span class="cl">host_name Dell NFS Server
</span></span><span class="line"><span class="cl">service_description Logged Users
</span></span><span class="line"><span class="cl">check_command check_nrpe!show_users
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">On NRPE Client:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">* Copy show_users file in <span class="s2">&#34;libexec&#34;</span> directory
</span></span><span class="line"><span class="cl">* vim nrpe.cfg, add below line
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">command<span class="o">[</span>show_users<span class="o">]=</span>/usr/local/nagios/libexec/show_users
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Save <span class="p">&amp;</span> Exit <span class="p">&amp;</span> restart NRPE/Xinetd service
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">That<span class="err">&#39;</span>s it.</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="配置-nagios-graph" class="heading-element">
  <a href="#%e9%85%8d%e7%bd%ae-nagios-graph" class="heading-mark"></a>配置 nagios-graph</h2><ul>
<li>参考这个博客:<a href="https://sysadminxpert.com/install-nagiosgraph-for-nagios-core-on-centos-7/"target="_blank" rel="external nofollow noopener noreferrer">Steps to Install Nagiosgraph for Nagios Core on CentOS 7<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li>安装的时候，一定要记得允许修改 <code>nagios</code> 与 <code>apache</code> 配置，<strong>不要一键到底</strong></li>
</ul>
<div class="highlight" id="id-22"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">locate /etc/httpd/conf/httpd.conf
</span></span><span class="line"><span class="cl"><span class="c1">## cgi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 先安装 perl-core</span>
</span></span><span class="line"><span class="cl">yum install -y perl-core
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 进入 perl 命令行模式，开始安装</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">perl -MCPAN -e shell
</span></span><span class="line"><span class="cl">1<span class="o">)</span> install Digest::MD5
</span></span><span class="line"><span class="cl">2<span class="o">)</span> install Nagios::Config
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 修改权限</span>
</span></span><span class="line"><span class="cl">chmod <span class="m">777</span> -R /usr/local/nagios
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 修改 templates.cfg, 一定要改成 /nagios/cgi-bin/....</span>
</span></span><span class="line"><span class="cl">define service <span class="o">{</span>
</span></span><span class="line"><span class="cl">    name            graphed-service
</span></span><span class="line"><span class="cl">    action_url      /nagios/cgi-bin/show.cgi?host<span class="o">=</span><span class="nv">$HOSTNAME</span>$<span class="p">&amp;</span><span class="nv">service</span><span class="o">=</span><span class="nv">$SERVICEDESC</span><span class="s1">$&#39; onMouseOver=&#39;</span>showGraphPopup<span class="o">(</span>this<span class="o">)</span><span class="s1">&#39; onMouseOut=&#39;</span>hideGraphPopup<span class="o">()</span><span class="s1">&#39; rel=&#39;</span>/nagiosgraph/cgi-bin/showgraph.cgi?host<span class="o">=</span><span class="nv">$HOSTNAME</span>$<span class="p">&amp;</span><span class="nv">service</span><span class="o">=</span><span class="nv">$SERVICEDESC</span>$<span class="p">&amp;</span><span class="nv">period</span><span class="o">=</span>week<span class="p">&amp;</span><span class="nv">rrdopts</span><span class="o">=</span>-w+450+-j
</span></span><span class="line"><span class="cl">    register        <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 测试打开 http://127.0.0.1:8080/nagios/cgi-bin/showconfig.cgi</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="配置-pnp4nagios" class="heading-element">
  <a href="#%e9%85%8d%e7%bd%ae-pnp4nagios" class="heading-mark"></a>配置 pnp4nagios</h2><ul>
<li><a href="http://120.132.124.40:8877/zixun/77838.html"target="_blank" rel="external nofollow noopener noreferrer">开源监控解决方案Nagios+Cacti+PNP4Nagios+NConf+NDOUtils+Nagvis（三）pnp4nagios安装<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ul>
<div class="highlight" id="id-23"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo /etc/init.d/npcd restart
</span></span><span class="line"><span class="cl">systemctl restart npcd
</span></span><span class="line"><span class="cl">systemctl restart httpd</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="安装-pnp4nagios" class="heading-element">
  <a href="#%e5%ae%89%e8%a3%85-pnp4nagios" class="heading-mark"></a>安装 pnp4nagios</h3><div class="highlight" id="id-24"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /tmp
</span></span><span class="line"><span class="cl">wget -O pnp4nagios.tar.gz https://github.com/lingej/pnp4nagios/archive/0.6.26.tar.gz
</span></span><span class="line"><span class="cl">tar -xvf pnp4nagios.tar.gz
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> pnp4nagios-0.6.26
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">./configure --with-rrdtool<span class="o">=</span>/usr/bin/rrdtool  --with-perfdata-dir<span class="o">=</span>/usr/local/nagios/share/perfdata --with-perfdata-spool-dir<span class="o">=</span>/usr/local/nagios/share/spool --with-nagios-user<span class="o">=</span>nagios --with-nagios-group<span class="o">=</span>nagios
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">make all
</span></span><span class="line"><span class="cl">make install
</span></span><span class="line"><span class="cl">make install-webconf
</span></span><span class="line"><span class="cl">make install-config
</span></span><span class="line"><span class="cl">make install-init</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="配置-1" class="heading-element">
  <a href="#%e9%85%8d%e7%bd%ae-1" class="heading-mark"></a>配置</h4><div class="highlight" id="id-25"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span>  /usr/local/pnp4nagios/etc
</span></span><span class="line"><span class="cl">mv misccommands.cfg-sample misccommands.cfg
</span></span><span class="line"><span class="cl">mv nagios.cfg-sample nagios.cfg
</span></span><span class="line"><span class="cl">mv rra.cfg-sample rra.cfg
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /usr/local/pnp4nagios/etc/pages/
</span></span><span class="line"><span class="cl">mv web_traffic.cfg-sample web_traffic.cfg
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> ../check_commands
</span></span><span class="line"><span class="cl">mv check_all_local_disks.cfg-sample  check_all_local_disks.cfg
</span></span><span class="line"><span class="cl">mv check_nrpe.cfg-sample  check_nrpe.cfg
</span></span><span class="line"><span class="cl">mv check_nwstat.cfg-sample  check_nwstat.cfg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 启动服务</span>
</span></span><span class="line"><span class="cl">sudo /etc/init.d/npcd restart
</span></span><span class="line"><span class="cl">systemctl restart npcd
</span></span><span class="line"><span class="cl">systemctl restart httpd
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 修改 /usr/local/nagios/etc/objects/templates.cfg</span>
</span></span><span class="line"><span class="cl">cp /usr/local/nagios/etc/objects/templates.cfg /usr/local/nagios/etc/objects/templates.cfg.orig
</span></span><span class="line"><span class="cl"><span class="c1">## ----------------------------------------------</span>
</span></span><span class="line"><span class="cl">vim /usr/local/nagios/etc/objects/templates.cfg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">define host <span class="o">{</span>
</span></span><span class="line"><span class="cl">      name       host-pnp
</span></span><span class="line"><span class="cl">      register   <span class="m">0</span>
</span></span><span class="line"><span class="cl">      action_url /pnp4nagios/index.php/graph?host<span class="o">=</span><span class="nv">$HOSTNAME</span>$<span class="p">&amp;</span><span class="nv">srv</span><span class="o">=</span>_HOST_<span class="s1">&#39; class=&#39;</span>tips<span class="s1">&#39; rel=&#39;</span>/pnp4nagios/index.php/popup?host<span class="o">=</span><span class="nv">$HOSTNAME</span>$<span class="p">&amp;</span><span class="nv">srv</span><span class="o">=</span>_HOST_
</span></span><span class="line"><span class="cl">      process_perf_data              <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">define service <span class="o">{</span>
</span></span><span class="line"><span class="cl">      name       srv-pnp
</span></span><span class="line"><span class="cl">      register   <span class="m">0</span>
</span></span><span class="line"><span class="cl">      action_url /pnp4nagios/index.php/graph?host<span class="o">=</span><span class="nv">$HOSTNAME</span>$<span class="p">&amp;</span><span class="nv">srv</span><span class="o">=</span><span class="nv">$SERVICEDESC</span><span class="s1">$&#39; class=&#39;</span>tips<span class="s1">&#39; rel=&#39;</span>/pnp4nagios/index.php/popup?host<span class="o">=</span><span class="nv">$HOSTNAME</span>$<span class="p">&amp;</span><span class="nv">srv</span><span class="o">=</span><span class="nv">$SERVICEDESC</span>$
</span></span><span class="line"><span class="cl">      process_perf_data              <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">define host<span class="o">{</span>
</span></span><span class="line"><span class="cl">       name                   gchost
</span></span><span class="line"><span class="cl">       use                    host-pnp
</span></span><span class="line"><span class="cl">       max_check_attempts       <span class="m">1</span>
</span></span><span class="line"><span class="cl">       normal_check_interval    <span class="m">2</span>
</span></span><span class="line"><span class="cl">       retry_check_interval     <span class="m">1</span>
</span></span><span class="line"><span class="cl">       check_period          24x7
</span></span><span class="line"><span class="cl">       contact_groups        myself_group
</span></span><span class="line"><span class="cl">       notification_interval  <span class="m">2</span>
</span></span><span class="line"><span class="cl">       notification_period   24x7
</span></span><span class="line"><span class="cl">       notification_options   d,u,r
</span></span><span class="line"><span class="cl">       check_command          check-host-alive
</span></span><span class="line"><span class="cl">       <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">define service<span class="o">{</span>
</span></span><span class="line"><span class="cl">       name                    myself_temp
</span></span><span class="line"><span class="cl">       use                     srv-pnp
</span></span><span class="line"><span class="cl">       max_check_attempts      <span class="m">2</span>
</span></span><span class="line"><span class="cl">       normal_check_interval   <span class="m">2</span>
</span></span><span class="line"><span class="cl">       retry_check_interval    <span class="m">1</span>
</span></span><span class="line"><span class="cl">       check_period            24x7
</span></span><span class="line"><span class="cl">       notification_interval   <span class="m">2</span>
</span></span><span class="line"><span class="cl">       notification_period     24x7
</span></span><span class="line"><span class="cl">       notification_options    w,u,c,r
</span></span><span class="line"><span class="cl">       contact_groups          myself_group
</span></span><span class="line"><span class="cl">       check_command           check-host-alive
</span></span><span class="line"><span class="cl">       register                <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 修改 /usr/local/nagios/etc/nagios.cfg</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /usr/local/nagios/etc/nagios.cfg /usr/local/nagios/etc/nagios.cfg.orig
</span></span><span class="line"><span class="cl"><span class="c1">## -------------------------------------</span>
</span></span><span class="line"><span class="cl">vim /usr/local/nagios/etc/nagios.cfg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">process_performance_data</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">enable_environment_macros</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">host_perfdata_file</span><span class="o">=</span>/usr/local/pnp4nagios/var/host-perfdata
</span></span><span class="line"><span class="cl"><span class="nv">service_perfdata_file</span><span class="o">=</span>/usr/local/pnp4nagios/var/service-perfdata
</span></span><span class="line"><span class="cl"><span class="nv">host_perfdata_file_template</span><span class="o">=</span>DATATYPE::HOSTPERFDATA<span class="se">\t</span>TIMET::<span class="nv">$TIMET</span>$<span class="se">\t</span>HOSTNAME::<span class="nv">$HOSTNAME</span>$<span class="se">\t</span>HOSTPERFDATA::<span class="nv">$HOSTPERFDATA</span>$<span class="se">\t</span>HOSTCHECKCOMMAND::<span class="nv">$HOSTCHECKCOMMAND</span>$<span class="se">\t</span>HOSTSTATE::<span class="nv">$HOSTSTATE</span>$<span class="se">\t</span>HOSTSTATETYPE::<span class="nv">$HOSTSTATETYPE</span>$
</span></span><span class="line"><span class="cl"><span class="nv">service_perfdata_file_template</span><span class="o">=</span>DATATYPE::SERVICEPERFDATA<span class="se">\t</span>TIMET::<span class="nv">$TIMET</span>$<span class="se">\t</span>HOSTNAME::<span class="nv">$HOSTNAME</span>$<span class="se">\t</span>SERVICEDESC::<span class="nv">$SERVICEDESC</span>$<span class="se">\t</span>SERVICEPERFDATA::<span class="nv">$SERVICEPERFDATA</span>$<span class="se">\t</span>SERVICECHECKCOMMAND::<span class="nv">$SERVICECHECKCOMMAND</span>$<span class="se">\t</span>HOSTSTATE::<span class="nv">$HOSTSTATE</span>$<span class="se">\t</span>HOSTSTATETYPE::<span class="nv">$HOSTSTATETYPE</span>$<span class="se">\t</span>SERVICESTATE::<span class="nv">$SERVICESTATE</span>$<span class="se">\t</span>SERVICESTATETYPE::<span class="nv">$SERVICESTATETYPE</span>$<span class="se">\t</span>SERVICEOUTPUT::<span class="nv">$SERVICEOUTPUT</span>$
</span></span><span class="line"><span class="cl"><span class="nv">host_perfdata_file_mode</span><span class="o">=</span>a
</span></span><span class="line"><span class="cl"><span class="nv">service_perfdata_file_mode</span><span class="o">=</span>a
</span></span><span class="line"><span class="cl"><span class="nv">host_perfdata_file_processing_interval</span><span class="o">=</span><span class="m">15</span>
</span></span><span class="line"><span class="cl"><span class="nv">service_perfdata_file_processing_interval</span><span class="o">=</span><span class="m">15</span>
</span></span><span class="line"><span class="cl"><span class="nv">host_perfdata_file_processing_command</span><span class="o">=</span>process-host-perfdata-file
</span></span><span class="line"><span class="cl"><span class="nv">service_perfdata_file_processing_command</span><span class="o">=</span>process-service-perfdata-file
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 修改 /usr/local/nagios/etc/objects/commands.cfg</span>
</span></span><span class="line"><span class="cl">cp /usr/local/nagios/etc/objects/commands.cfg /usr/local/nagios/etc/objects/commands.cfg.orig
</span></span><span class="line"><span class="cl"><span class="c1">## --------------------------------------------------</span>
</span></span><span class="line"><span class="cl">vim /usr/local/nagios/etc/objects/commands.cfg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">define command<span class="o">{</span>
</span></span><span class="line"><span class="cl">    command_name process-service-perfdata-file
</span></span><span class="line"><span class="cl">    command_line /usr/local/pnp4nagios/libexec/process_perfdata.pl --bulk<span class="o">=</span>/usr/local/pnp4nagios/var/service-perfdata
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">define command<span class="o">{</span>
</span></span><span class="line"><span class="cl">    command_name process-host-perfdata-file
</span></span><span class="line"><span class="cl">    command_line /usr/local/pnp4nagios/libexec/process_perfdata.pl --bulk<span class="o">=</span>/usr/local/pnp4nagios/var/host-perfdata
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 修改 apache 配置  /etc/httpd/conf/httpd.conf</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /etc/httpd/conf/httpd.conf /etc/httpd/conf/httpd.conf.orig
</span></span><span class="line"><span class="cl"><span class="c1">## -----------------------------------</span>
</span></span><span class="line"><span class="cl">vim /etc/httpd/conf/httpd.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Alias /pnp4nagios <span class="s2">&#34;/usr/local/pnp4nagios/share&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;Directory <span class="s2">&#34;/usr/local/pnp4nagios/share&#34;</span>&gt;
</span></span><span class="line"><span class="cl">    AllowOverride None
</span></span><span class="line"><span class="cl">    Order allow,deny
</span></span><span class="line"><span class="cl">    Allow from all
</span></span><span class="line"><span class="cl">    <span class="c1">#</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Use the same value as defined in nagios.conf</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#</span>
</span></span><span class="line"><span class="cl">    AuthName <span class="s2">&#34;Nagios Access&#34;</span>
</span></span><span class="line"><span class="cl">    AuthType Basic
</span></span><span class="line"><span class="cl">    AuthUserFile /usr/local/nagios/etc/htpasswd.users
</span></span><span class="line"><span class="cl">    Require valid-user
</span></span><span class="line"><span class="cl">        &lt;IfModule mod_rewrite.c&gt;
</span></span><span class="line"><span class="cl">                  <span class="c1">#Turn on URL rewriting</span>
</span></span><span class="line"><span class="cl">                  RewriteEngine On
</span></span><span class="line"><span class="cl">                  Options symLinksIfOwnerMatch
</span></span><span class="line"><span class="cl">                  <span class="c1">#Installation directory</span>
</span></span><span class="line"><span class="cl">                  RewriteBase /pnp4nagios/
</span></span><span class="line"><span class="cl">                  <span class="c1">#Protect application and system files from being viewed</span>
</span></span><span class="line"><span class="cl">                  RewriteRule <span class="s2">&#34;^(?:application|modules|system)/&#34;</span> - <span class="o">[</span>F<span class="o">]</span>
</span></span><span class="line"><span class="cl">                  <span class="c1">#Allow any files or directories that exist to be displayed directly</span>
</span></span><span class="line"><span class="cl">                  RewriteCond <span class="s2">&#34;%{REQUEST_FILENAME}&#34;</span> !-f
</span></span><span class="line"><span class="cl">                  RewriteCond <span class="s2">&#34;%{REQUEST_FILENAME}&#34;</span> !-d
</span></span><span class="line"><span class="cl">                  <span class="c1">#Rewrite all other URLs to index.php/URL</span>
</span></span><span class="line"><span class="cl">                  RewriteRule <span class="s2">&#34;^.*</span>$<span class="s2">&#34;</span> <span class="s2">&#34;index.php/</span><span class="nv">$0</span><span class="s2">&#34;</span> <span class="o">[</span>PT<span class="o">]</span>
</span></span><span class="line"><span class="cl">        &lt;/IfModule&gt;
</span></span><span class="line"><span class="cl">&lt;/Directory&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 查看效果：http://&lt;ip&gt;:&lt;port&gt;/pnp4nagios/</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 检查各项安装是否符合条件，然后删除这个页面</span>
</span></span><span class="line"><span class="cl">mv /usr/local/pnp4nagios/share/install.php /usr/local/pnp4nagios/share/install.php.orig
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 复制鼠标悬停效果: 在下载的源代码里面，如 /tmp/pnp4nagios-0.6.26/contrib</span>
</span></span><span class="line"><span class="cl">cp /tmp/pnp4nagios-0.6.26/contrib/ssi/* /usr/local/nagios/share/ssi/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 测试启动</span>
</span></span><span class="line"><span class="cl">/usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg
</span></span><span class="line"><span class="cl">systemctl restart httpd
</span></span><span class="line"><span class="cl">systemctl restart npcd
</span></span><span class="line"><span class="cl">systemctl restart nagios
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 应用到监控项目</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 由于 pnp4nagios 与 nagios-graph 冲突，二者只能选一个使用</span>
</span></span><span class="line"><span class="cl">vim /usr/local/nagios/etc/colo-machines/colo118.cfg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">define service <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># use                             local-service,graphed-service,srv-pnp           ; Name of service template to use</span>
</span></span><span class="line"><span class="cl">    use                             local-service,srv-pnp           <span class="p">;</span> Name of service template to use
</span></span><span class="line"><span class="cl">    host_name                       Colo118
</span></span><span class="line"><span class="cl">    service_description             Current Proc Memory valv_out_zz1
</span></span><span class="line"><span class="cl">    check_command                   check_nrpex!15118!check_proc_mem!<span class="s2">&#34;-w10240 -c20480 --pattern=.*valv.out.zz1.*&#34;</span>
</span></span><span class="line"><span class="cl">    check_interval                  <span class="m">3</span>
</span></span><span class="line"><span class="cl">    retry_interval                  <span class="m">1</span>
</span></span><span class="line"><span class="cl">    check_period                    24x7
</span></span><span class="line"><span class="cl">    notification_interval           <span class="m">1</span>
</span></span><span class="line"><span class="cl">    notification_period             24x7
</span></span><span class="line"><span class="cl">    notifications_enabled           <span class="m">1</span>
</span></span><span class="line"><span class="cl">    register                        <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="grafana" class="heading-element">
  <a href="#grafana" class="heading-mark"></a>grafana</h3><ul>
<li><a href="https://www.zybuluo.com/sww4718168/note/116559"target="_blank" rel="external nofollow noopener noreferrer">nagios+grafana<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://www.centlinux.com/2019/02/install-grafana-pnp4nagios-centos-7.html"target="_blank" rel="external nofollow noopener noreferrer">https://www.centlinux.com/2019/02/install-grafana-pnp4nagios-centos-7.html<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ul>
<div class="highlight" id="id-26"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /tmp
</span></span><span class="line"><span class="cl">wget https://dl.grafana.com/enterprise/release/grafana-enterprise-10.0.0-1.x86_64.rpm
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 安装 grafana</span>
</span></span><span class="line"><span class="cl">sudo yum install grafana-enterprise-10.0.0-1.x86_64.rpm
</span></span><span class="line"><span class="cl">systemctl daemon-reload
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> grafana-server.service
</span></span><span class="line"><span class="cl">systemctl start grafana-server.service
</span></span><span class="line"><span class="cl">systemctl restart grafana-server.service
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 安装 PNP plugin</span>
</span></span><span class="line"><span class="cl">sudo grafana-cli plugins install sni-pnp-datasource
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># service firewalld restart</span>
</span></span><span class="line"><span class="cl"><span class="c1"># firewall-cmd --permanent --add-port=3000/tcp</span>
</span></span><span class="line"><span class="cl"><span class="c1"># firewall-cmd --reload</span>
</span></span><span class="line"><span class="cl"><span class="c1"># service firewalld restart</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 下载 api</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /usr/local/pnp4nagios/share/application/controllers/
</span></span><span class="line"><span class="cl">wget -O api.php <span class="s2">&#34;https://github.com/lingej/pnp-metrics-api/raw/master/application/controller/api.php&#34;</span>
</span></span><span class="line"><span class="cl">systemctl restart grafana-server.service
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 配置 pnp4nagios</span>
</span></span><span class="line"><span class="cl">cp /etc/httpd/conf.d/pnp4nagios.conf /etc/httpd/conf.d/pnp4nagios.conf.orig
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;/Allow from all/a\        Allow from 127.0.0.1 ::1&#39;</span> /etc/httpd/conf.d/pnp4nagios.conf
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;/Require valid-user/a\        Require all granted&#39;</span> /etc/httpd/conf.d/pnp4nagios.conf
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;/Require valid-user/a\        Require ip 127.0.0.1 ::1&#39;</span> /etc/httpd/conf.d/pnp4nagios.conf
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/Allow from all/#&amp;/&#39;</span> /etc/httpd/conf.d/pnp4nagios.conf
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/AuthName/#&amp;/&#39;</span> /etc/httpd/conf.d/pnp4nagios.conf
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/AuthType Basic/#&amp;/&#39;</span> /etc/httpd/conf.d/pnp4nagios.conf
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/AuthUserFile/#&amp;/&#39;</span> /etc/httpd/conf.d/pnp4nagios.conf
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/Require valid-user/#&amp;/&#39;</span> /etc/httpd/conf.d/pnp4nagios.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">systemctl restart httpd.service
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## 配置 grafana, 首次登录，账户:admin，密码:admin</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 配置 pnp data source</span>
</span></span><span class="line"><span class="cl"><span class="c1">## 生成密码，使用这个在 grafana 登录 pnp</span>
</span></span><span class="line"><span class="cl">htpasswd -b /usr/local/nagios/etc/htpasswd.users nagiosadmin *********
</span></span><span class="line"><span class="cl"><span class="c1">## 打开页面, http://127.0.0.1:3000</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="./assets/grafana-pnp.png" alt="./assets/grafana-pnp.png" srcset="./assets/grafana-pnp.png?size=small, ./assets/grafana-pnp.png?size=medium 1.5x, ./assets/grafana-pnp.png?size=large 2x" data-title="./assets/grafana-pnp.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p><img loading="lazy" src="./assets/grafana-pnp-colo118.png" alt="./assets/grafana-pnp-colo118.png" srcset="./assets/grafana-pnp-colo118.png?size=small, ./assets/grafana-pnp-colo118.png?size=medium 1.5x, ./assets/grafana-pnp-colo118.png?size=large 2x" data-title="./assets/grafana-pnp-colo118.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="企业微信通知" class="heading-element">
  <a href="#%e4%bc%81%e4%b8%9a%e5%be%ae%e4%bf%a1%e9%80%9a%e7%9f%a5" class="heading-mark"></a>企业微信通知</h3><blockquote>
<p>企业微信对于机器人与群助手的渲染不一样，导致 <code>\n</code> 的判断不同</p>
<div class="highlight" id="id-27"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;Robot&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">w</span><span class="p">)),</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">msgx</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">msgx</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;br&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;br&gt;&#39;</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<p>参考：</p>
<ul>
<li><a href="https://www.thegeekstuff.com/2009/06/4-steps-to-define-nagios-contacts-with-email-and-pager-notification/"target="_blank" rel="external nofollow noopener noreferrer">4 Steps to Define Nagios Contacts With Email and Pager Notification<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://subscription.packtpub.com/book/cloud-and-networking/9781849515566/1/ch01lvl1sec11/creating-a-new-e-mail-contact"target="_blank" rel="external nofollow noopener noreferrer">Creating a new e-mail contact<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://assets.nagios.com/downloads/nagioscore/docs/nagioscore/3/en/macrolist.html"target="_blank" rel="external nofollow noopener noreferrer">nagios macro<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li>介绍如何使用 <code>nagios</code> 宏定义：<a href="http://nagios.manubulon.com/traduction/docs25en/macros.html"target="_blank" rel="external nofollow noopener noreferrer">using macro in commans<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ul>
<h4 id="建立-python-通知脚本" class="heading-element">
  <a href="#%e5%bb%ba%e7%ab%8b-python-%e9%80%9a%e7%9f%a5%e8%84%9a%e6%9c%ac" class="heading-mark"></a>建立 python 通知脚本</h4><div class="highlight" id="id-28"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">wepy.utils.init</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">## -------------------------------------------</span>
</span></span><span class="line"><span class="cl">    <span class="n">cli</span> <span class="o">=</span> <span class="n">CliParser</span><span class="p">(</span><span class="s2">&#34;wechat from command line&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cli</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&#34;who&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;wx_test&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cli</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&#34;msg&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cli</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&#34;level&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cli</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">## -------------------------------------------</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">cli</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">who</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">            </span><span class="si">{</span><span class="n">cli</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">who</span><span class="si">=}</span><span class="s2"> does not exist
</span></span></span><span class="line"><span class="cl"><span class="s2">            &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="n">err</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">w</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">who</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;Robot&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">w</span><span class="p">)),</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">msgx</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">msgx</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;br&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;br&gt;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">w</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msgx</span><span class="p">,</span> <span class="n">cli</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">level</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="修改-generic-contact" class="heading-element">
  <a href="#%e4%bf%ae%e6%94%b9-generic-contact" class="heading-mark"></a>修改 generic-contact</h4><p>这个是<strong>模板</strong>，我们可以通过继承来实现具体的 <code>contact1</code></p>
<div class="highlight" id="id-29"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vim /usr/local/nagios/etc/objects/templates.cfg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">define contact <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    name                            generic-contact         <span class="p">;</span> The name of this contact template
</span></span><span class="line"><span class="cl">    service_notification_period     24x7                    <span class="p">;</span> service notifications can be sent anytime
</span></span><span class="line"><span class="cl">    host_notification_period        24x7                    <span class="p">;</span> host notifications can be sent anytime
</span></span><span class="line"><span class="cl">    <span class="c1"># service_notification_options    w,u,c,r,f,s             ; send notifications for all service states, flapping events, and scheduled downtime events</span>
</span></span><span class="line"><span class="cl">    service_notification_options    u,c,r,f,s             <span class="p">;</span> send notifications <span class="k">for</span> all service states, flapping events, and scheduled downtime events
</span></span><span class="line"><span class="cl">    host_notification_options       d,u,r,f,s               <span class="p">;</span> send notifications <span class="k">for</span> all host states, flapping events, and scheduled downtime events
</span></span><span class="line"><span class="cl">    <span class="c1"># service_notification_commands   notify-service-by-email,notify-service-by-wechat    ; send service notifications via email</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># host_notification_commands      notify-host-by-email,notify-host-by-wechat          ; send host notifications via email</span>
</span></span><span class="line"><span class="cl">    service_notification_commands   notify-service-by-wechat    <span class="p">;</span> send service notifications via email
</span></span><span class="line"><span class="cl">    host_notification_commands      notify-host-by-wechat          <span class="p">;</span> send host notifications via email
</span></span><span class="line"><span class="cl">    register                        <span class="m">0</span>                       <span class="p">;</span> DON<span class="err">&#39;</span>T REGISTER THIS DEFINITION - ITS NOT A REAL CONTACT, JUST A TEMPLATE!
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="修改-contact" class="heading-element">
  <a href="#%e4%bf%ae%e6%94%b9-contact" class="heading-mark"></a>修改 contact</h4><div class="highlight" id="id-30"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vim /usr/local/nagios/etc/objects/contacts.cfg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">define contact <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    contact_name            nagiosadmin             <span class="p">;</span> Short name of user
</span></span><span class="line"><span class="cl">    use                     generic-contact         <span class="p">;</span> Inherit default values from generic-contact template <span class="o">(</span>defined above<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">alias</span>                   Nagios Admin            <span class="p">;</span> Full name of user
</span></span><span class="line"><span class="cl">    <span class="c1"># email                   nagios@localhost ; &lt;&lt;***** CHANGE THIS TO YOUR EMAIL ADDRESS ******</span>
</span></span><span class="line"><span class="cl">    email                   william.lian.fang@gmail.com <span class="p">;</span> &lt;&lt;***** CHANGE THIS TO YOUR EMAIL ADDRESS ******
</span></span><span class="line"><span class="cl">    host_notification_commands     notify-host-by-wechat
</span></span><span class="line"><span class="cl">    host_notification_options      d,u,r
</span></span><span class="line"><span class="cl">    host_notification_period       24x7
</span></span><span class="line"><span class="cl">    service_notification_commands  notify-service-by-wechat
</span></span><span class="line"><span class="cl">    service_notification_options   w,u,c,r  <span class="p">;</span> 可以修改不同的设置
</span></span><span class="line"><span class="cl">    service_notification_period    24x7
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">define contact <span class="o">{</span>
</span></span><span class="line"><span class="cl">    contact_name                    <span class="nb">test</span>                 <span class="p">;</span> Short name of user
</span></span><span class="line"><span class="cl">    use                             generic-contact         <span class="p">;</span> Inherit default values from generic-contact template <span class="o">(</span>defined above<span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">alias</span>                           Nagios Dev              <span class="p">;</span> Full name of user
</span></span><span class="line"><span class="cl">    email                           william.lian.fang@gmail.com <span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    host_notifications_enabled      <span class="m">1</span>
</span></span><span class="line"><span class="cl">    service_notifications_enabled   <span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    host_notification_period        24x7
</span></span><span class="line"><span class="cl">    service_notification_period     24x7
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    host_notification_options       d,u,r,f,s,n
</span></span><span class="line"><span class="cl">    service_notification_options    w,u,c,r,f,s             <span class="p">;</span> send notifications <span class="k">for</span> all service states, flapping events, and scheduled downtime events
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    host_notification_commands      notify-host-by-wechat-test
</span></span><span class="line"><span class="cl">    service_notification_commands   notify-service-by-wechat-test
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>还可以设置 <code>contact-groups</code></p>
<div class="highlight" id="id-31"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vim /usr/local/nagios/etc/objects/contacts.cfg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">define contactgroup <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    contactgroup_name       admins
</span></span><span class="line"><span class="cl">    <span class="nb">alias</span>                   Nagios Administrators
</span></span><span class="line"><span class="cl">    members                 nagiosadmin,test
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="添加监控-commands" class="heading-element">
  <a href="#%e6%b7%bb%e5%8a%a0%e7%9b%91%e6%8e%a7-commands" class="heading-mark"></a>添加监控 commands</h4><div class="highlight" id="id-32"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vim /usr/local/nagios/etc/objects/commands.cfg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">##### notify-host-by-wechat command definition</span>
</span></span><span class="line"><span class="cl">define command<span class="o">{</span>
</span></span><span class="line"><span class="cl">    command_name notify-host-by-wechat
</span></span><span class="line"><span class="cl">    command_line /usr/local/python3/bin/python3 /app/wechat_cli.py --who<span class="o">=</span><span class="s1">&#39;wx_test&#39;</span> --msg<span class="o">=</span><span class="k">$(</span>/usr/bin/printf <span class="s2">&#34;%b&#34;</span> <span class="s2">&#34;***** Nagios *****\n\nNotification Type: </span><span class="nv">$NOTIFICATIONTYPE</span>$<span class="s2">\nHost: </span><span class="nv">$HOSTNAME</span>$<span class="s2">\nState: </span><span class="nv">$HOSTSTATE</span>$<span class="s2">\nAddress: </span><span class="nv">$HOSTADDRESS</span>$<span class="s2">\nInfo: </span><span class="nv">$HOSTOUTPUT</span>$<span class="s2">\n\nDate/Time: </span><span class="nv">$LONGDATETIME</span>$<span class="s2">\n&#34;</span><span class="k">)</span> --level<span class="o">=</span><span class="s1">&#39;$HOSTSTATE$&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">##### notify-service-by-wechat command definition</span>
</span></span><span class="line"><span class="cl">define command<span class="o">{</span>
</span></span><span class="line"><span class="cl">    command_name notify-service-by-wechat
</span></span><span class="line"><span class="cl">    command_line /usr/local/python3/bin/python3 /app/wechat_cli.py --who<span class="o">=</span><span class="s1">&#39;robot_secops&#39;</span> --msg<span class="o">=</span><span class="s2">&#34;***** Nagios *****\nNotification Type: </span><span class="nv">$NOTIFICATIONTYPE</span>$<span class="s2">\n\nService: </span><span class="nv">$SERVICEDESC</span>$<span class="s2">\nHost: </span><span class="nv">$HOSTALIAS</span>$<span class="s2">\nAddress: </span><span class="nv">$HOSTADDRESS</span>$<span class="s2">\nState: </span><span class="nv">$SERVICESTATE</span>$<span class="s2">\n\nDate/Time: </span><span class="nv">$LONGDATETIME</span>$<span class="s2">\n\nAdditional Info:\n</span><span class="nv">$SERVICEOUTPUT</span>$<span class="s2">&#34;</span> --level<span class="o">=</span><span class="s1">&#39;$SERVICESTATE$&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">define command<span class="o">{</span>
</span></span><span class="line"><span class="cl">    command_name notify-host-by-wechat-test
</span></span><span class="line"><span class="cl">    command_line /usr/local/python3/bin/python3 /app/wechat_cli.py --who<span class="o">=</span><span class="s1">&#39;wx_test&#39;</span> --msg<span class="o">=</span><span class="k">$(</span>/usr/bin/printf <span class="s2">&#34;%b&#34;</span> <span class="s2">&#34;***** Nagios *****\n\nNotification Type: </span><span class="nv">$NOTIFICATIONTYPE</span>$<span class="s2">\nHost: </span><span class="nv">$HOSTNAME</span>$<span class="s2">\nState: </span><span class="nv">$HOSTSTATE</span>$<span class="s2">\nAddress: </span><span class="nv">$HOSTADDRESS</span>$<span class="s2">\nInfo: </span><span class="nv">$HOSTOUTPUT</span>$<span class="s2">\n\nDate/Time: </span><span class="nv">$LONGDATETIME</span>$<span class="s2">\n&#34;</span><span class="k">)</span> --level<span class="o">=</span><span class="s1">&#39;$HOSTSTATE$&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">define command<span class="o">{</span>
</span></span><span class="line"><span class="cl">    command_name notify-service-by-wechat-test
</span></span><span class="line"><span class="cl">    command_line /usr/local/python3/bin/python3 /app/wechat_cli.py --who<span class="o">=</span><span class="s1">&#39;wx_test&#39;</span> --msg<span class="o">=</span><span class="s2">&#34;***** Nagios *****\nNotification Type: </span><span class="nv">$NOTIFICATIONTYPE</span>$<span class="s2">\n\nService: </span><span class="nv">$SERVICEDESC</span>$<span class="s2">\nHost: </span><span class="nv">$HOSTALIAS</span>$<span class="s2">\nAddress: </span><span class="nv">$HOSTADDRESS</span>$<span class="s2">\nState: </span><span class="nv">$SERVICESTATE</span>$<span class="s2">\n\nDate/Time: </span><span class="nv">$LONGDATETIME</span>$<span class="s2">\n\nAdditional Info:\n</span><span class="nv">$SERVICEOUTPUT</span>$<span class="s2">&#34;</span> --level<span class="o">=</span><span class="s1">&#39;$SERVICESTATE$&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="设置监控项目" class="heading-element">
  <a href="#%e8%ae%be%e7%bd%ae%e7%9b%91%e6%8e%a7%e9%a1%b9%e7%9b%ae" class="heading-mark"></a>设置监控项目</h4><div class="highlight" id="id-33"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">define host <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">## --------------------------------</span>
</span></span><span class="line"><span class="cl">    contacts              	nagiosadmin 	<span class="p">;</span> 以上的 contacts 组
</span></span><span class="line"><span class="cl">    notifications_enabled   <span class="m">1</span> 				<span class="p">;</span> 0, <span class="m">1</span>
</span></span><span class="line"><span class="cl">	<span class="c1">## --------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">define service <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">## --------------------------------</span>
</span></span><span class="line"><span class="cl">    contacts              	nagiosadmin 	<span class="p">;</span> 以上的 contacts 组
</span></span><span class="line"><span class="cl">    notifications_enabled   <span class="m">1</span> 				<span class="p">;</span> 0, <span class="m">1</span>
</span></span><span class="line"><span class="cl">	<span class="c1">## --------------------------------</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">define service
</span></span><span class="line"><span class="cl">    <span class="c1"># use                             local-service,graphed-service,srv-pnp           ; Name of service template to use</span>
</span></span><span class="line"><span class="cl">    use                             local-service,srv-pnp           <span class="p">;</span> Name of service template to use
</span></span><span class="line"><span class="cl">    host_name                       Colo118
</span></span><span class="line"><span class="cl">    service_description             NTP <span class="nb">time</span>
</span></span><span class="line"><span class="cl">    check_command                   check_nrpex!15118!check_ntp_time!<span class="s2">&#34;--benchmark=</span><span class="k">$(</span><span class="nb">echo</span> <span class="k">$(</span>date +%Y-%m-%dT%H:%M:%S.%6N<span class="k">))</span><span class="s2"> --warning=300000 --critical=500000&#34;</span>
</span></span><span class="line"><span class="cl">    check_interval                  <span class="m">1</span>
</span></span><span class="line"><span class="cl">    retry_interval                  <span class="m">1</span>
</span></span><span class="line"><span class="cl">    check_period                    24x7
</span></span><span class="line"><span class="cl">    notification_interval           <span class="m">1</span>
</span></span><span class="line"><span class="cl">    notification_period             24x7
</span></span><span class="line"><span class="cl">    notifications_enabled           <span class="m">1</span>
</span></span><span class="line"><span class="cl">    register                        <span class="m">1</span>
</span></span><span class="line"><span class="cl">    contacts                        <span class="nb">test</span> <span class="p">;</span> 用法发送监控
</span></span><span class="line"><span class="cl"><span class="o">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="./assets/wxchat.png" alt="./assets/wxchat.png" srcset="./assets/wxchat.png?size=small, ./assets/wxchat.png?size=medium 1.5x, ./assets/wxchat.png?size=large 2x" data-title="./assets/wxchat.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h1 id="ref" class="heading-element">
  <a href="#ref" class="heading-mark"></a>Ref</h1><ul>
<li><a href="https://gist.github.com/evanjuang/d81ca6f05aa02e2d92ad68f5f867235c"target="_blank" rel="external nofollow noopener noreferrer">Nagios on CentOS 7<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://www.psychz.net/client/question/en/how-to-install-nagios-on-linux-step-by-step.html"target="_blank" rel="external nofollow noopener noreferrer">How to install Nagios on linux step by step?<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://www.thegeekstuff.com/2010/12/enable-nrpe-command-arguments/"target="_blank" rel="external nofollow noopener noreferrer">Nagios: How to Enable check_nrpe Command Line Arguments<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://support.nagios.com/kb/article/nrpe-configuring-nrpe-commands-to-accept-arguments-759.html"target="_blank" rel="external nofollow noopener noreferrer">NRPE - Configuring NRPE Commands To Accept Arguments<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://www.cnblogs.com/ginvip/p/6506008.html"target="_blank" rel="external nofollow noopener noreferrer">Nagios服务器端配置文件详解<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://github.com/mconf/installation-scripts/blob/master/nagios/install-nagios.sh"target="_blank" rel="external nofollow noopener noreferrer">install-nagios.sh<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://github.com/loitho/Docker-Nagios-Nagvis-Nagiosgraph/blob/master/run.sh"target="_blank" rel="external nofollow noopener noreferrer">nagios-graph<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://sysadminxpert.com/install-nagiosgraph-for-nagios-core-on-centos-7/"target="_blank" rel="external nofollow noopener noreferrer">Steps to Install Nagiosgraph for Nagios Core on CentOS 7<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
<li><a href="https://nagios.fm4dd.com/nagiosgraph/"target="_blank" rel="external nofollow noopener noreferrer">nagios-graph<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ul></div><h2 id="see-also">相关内容</h2>
    <ul><li>
          <a href="/2023-07-08-nagios-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" title="nagios 安装与使用">nagios 安装与使用</a></li><li>
          <a href="/2023-06-26-zsh-no-match-found-for-/" title="zsh no match found for *">zsh no match found for *</a></li><li>
          <a href="/2023-06-18-linux-%E8%AE%BE%E7%BD%AE-cpu-%E9%AB%98%E6%80%A7%E8%83%BDperformance%E6%A8%A1%E5%BC%8F/" title="Linux 设置 cpu 高性能performance模式">Linux 设置 cpu 高性能performance模式</a></li><li>
          <a href="/2023-06-16-linux--%E6%96%B0%E8%B4%AD%E7%A1%AC%E7%9B%98%E6%89%A9%E5%AE%B9/" title="Linux: 新购硬盘扩容">Linux: 新购硬盘扩容</a></li><li>
          <a href="/2023-02-15-bashrc-prompt-%E9%A2%9C%E8%89%B2%E8%AE%BE%E7%BD%AE/" title="bashrc prompt 颜色设置">bashrc prompt 颜色设置</a></li></ul><div class="post-reward">
    <div class="comment"></div>
    <input type="checkbox" class="reward-input" name="reward" id="fi-reward" hidden />
    <label class="reward-button" for="fi-reward">赞赏</label>
    <div class="reward-ways" data-mode="static"><div><img loading="lazy" src="/images/reward/alipay.png" alt="william 支付宝" data-title="william 支付宝" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span data-animation>支付宝</span>
          </div><div><img loading="lazy" src="/images/reward/wechat.png" alt="william 微信" data-title="william 微信" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span data-animation>微信</span>
          </div></div>
  </div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2023-07-09 16:58:33">更新于 2023-07-09&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="/2023-07-09-nagios-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://williamlfang.github.io/2023-07-09-nagios-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" data-title="nagios 安装与使用" data-hashtags="Linux,CentOS,nagios,openssl,log,monitor"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://williamlfang.github.io/2023-07-09-nagios-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" data-hashtag="Linux"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="https://williamlfang.github.io/2023-07-09-nagios-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" data-title="nagios 安装与使用" data-web><i class="fa-brands fa-whatsapp fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Reddit" data-sharer="reddit" data-url="https://williamlfang.github.io/2023-07-09-nagios-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/"><i class="fa-brands fa-reddit fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://williamlfang.github.io/2023-07-09-nagios-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" data-title="nagios 安装与使用"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://williamlfang.github.io/2023-07-09-nagios-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" data-title="nagios 安装与使用"><i class="fa-brands fa-evernote fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/linux/" class="post-tag" title="标签 - Linux">Linux</a><a href="/tags/centos/" class="post-tag" title="标签 - CentOS">CentOS</a><a href="/tags/nagios/" class="post-tag" title="标签 - Nagios">Nagios</a><a href="/tags/openssl/" class="post-tag" title="标签 - Openssl">Openssl</a><a href="/tags/log/" class="post-tag" title="标签 - Log">Log</a><a href="/tags/monitor/" class="post-tag" title="标签 - Monitor">Monitor</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/2023-07-08-nagios-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/" class="post-nav-item" rel="prev" title="nagios 安装与使用"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>nagios 安装与使用</a>
      <a href="/2023-07-14-vim-latex/" class="post-nav-item" rel="next" title="vim latex">vim latex<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="giscus">
          <script
            src="https://giscus.app/client.js"
            data-repo="williamlfang/williamlfang.github.io"
            data-repo-id="R_kgDOHFHgDA"
            data-category="Announcements"
            data-category-id="DIC_kwDOHFHgDM4CeCG-"
            data-mapping="pathname"
            data-strict="0"
            
            data-theme="preferred_color_scheme"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="bottom"
            data-lang="zh-CN"
            data-loading="lazy"
            crossorigin="anonymous"
            async
            defer
          ></script>
        </div>
        <noscript>
          Please enable JavaScript to view the comments powered by <a href="https://giscus.app/" rel="external nofollow noopener noreferrer">giscus</a>.
        </noscript></div></article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.123.8"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.2"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2013 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/">william</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric">0%</span>
        </div><div class="fixed-button view-comments d-none" role="button" aria-label="查看评论"><i class="fa-solid fa-comment fa-fw" aria-hidden="true"></i></div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/twemoji/twemoji.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"autoBookmark":true,"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":25},"comment":{"enable":true,"expired":false,"giscus":{"darkTheme":"dark","lightTheme":"light"}},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"enablePWA":true,"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"twemoji":true};</script><script src="/js/theme.min.js" defer></script></body>
</html>
